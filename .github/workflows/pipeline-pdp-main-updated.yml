name: "Pipeline: PDP main updated"

on:
  push:
    branches: [ main ]
    paths-ignore: [ "docs/**" ]
  workflow_dispatch:
    inputs:
      reltype: { type: choice, required: true, options: [ "auto", "none", "patch", "minor", "major" ],
                 description: "Release type" }

jobs:
  plan:
    name: "Plan"
    permissions: { contents: read }
    runs-on: ubuntu-latest
    outputs:
      reltype: ${{ steps.vars.outputs.reltype }}  # type of release (or none)
      gtag:    ${{ steps.vars.outputs.gtag }}     # name of the Git tag to create
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0    # } ensure that previous Git tags are included
          fetch-tags: true  # }

      - name: "Determine variable values"
        id:   vars
        shell: bash
        run: |
          set -eu
          PREV_GTAG="$(git describe --tags --abbrev=0 --match "v[0-9]*" 2>/dev/null || echo v0.0.0)"
          if git rev-parse -q --verify "$PREV_GTAG" >/dev/null 2>&1; then COMMITS="${PREV_GTAG}..HEAD"; else COMMITS="HEAD"; fi
          BUMP="none"
          if ${{ github.event_name == 'workflow_dispatch' && inputs.reltype != 'auto' }}; then BUMP="${{ inputs.reltype }}"
          elif (git log --no-merges --format=%s "$COMMITS" | grep -Eqm1 '^[a-z]+(\([^)]+\))?!: '); then BUMP="major"
          elif (git log --no-merges --format=%B "$COMMITS" | grep -Eqm1 'BREAKING[ -]CHANGE:'); then BUMP="major"
          elif (git log --no-merges --format=%s "$COMMITS" | grep -Eqm1 '^feat(\([^)]+\))?: '); then BUMP="minor"
          elif (git log --no-merges --format=%s "$COMMITS" | grep -Eqm1 '^(fix|chore|refactor)(\([^)]+\))?: '); then BUMP="patch"
          fi
          if [[ "$PREV_GTAG" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            MAJOR=${BASH_REMATCH[1]}; MINOR=${BASH_REMATCH[2]}; PATCH=${BASH_REMATCH[3]}
          else
            echo "Unrecognised last Git tag \"$PREV_GTAG\", using v0.0.0" >&2
            MAJOR=0; MINOR=0; PATCH=0
          fi
          case "$BUMP" in
            major) MAJOR=$((MAJOR+1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR+1)); PATCH=0 ;;
            patch) PATCH=$((PATCH+1)) ;;
            none)  ;;
          esac
          NEXT_GTAG=""; if [[ "$BUMP" != "none" ]]; then NEXT_GTAG="v${MAJOR}.${MINOR}.${PATCH}"; fi
          echo "- PREV_GTAG=$PREV_GTAG; MAJOR=$MAJOR; MINOR=$MINOR; PATCH=$PATCH"
          echo "- github.event_name=${{ github.event_name }}"
          echo "- github.ref_name=${{ github.ref_name }}"
          echo "- outputs.gtag=$NEXT_GTAG"
          echo "- outputs.reltype=$BUMP"
          echo "gtag=$NEXT_GTAG" >> "$GITHUB_OUTPUT"
          echo "reltype=$BUMP" >> "$GITHUB_OUTPUT"

  source-scan:
    name: "Source scan"
    needs: [ plan ]
    permissions: { contents: read }
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - run: |
          ### Check the Helm chart lints OK
          helm lint ./helm_deploy/provider-data-platform --quiet --strict

  make-image:
    name: "Build ${{ needs.plan.outputs.gtag }}"
    if:   needs.plan.outputs.gtag && (needs.plan.outputs.reltype != 'none')
    needs: [ plan ]
    permissions: { contents: read, id-token: write, packages: write }
    uses: ./.github/workflows/rw-pdp-build.yml
    with:
      itag: ${{ needs.plan.outputs.gtag }}
    secrets: inherit

  gtag-release:
    name: "Git tag and GitHub Release"
    needs: [ plan, make-image ]
    permissions: { contents: write }
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: "Create Git tag"
        env:
          GTAG: ${{ needs.plan.outputs.gtag }}
        run: |
          test -n "$GTAG"  # fail if empty
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          echo "Trying to create Git tag [$GTAG]"
          git tag -a "$GTAG" -m "Release $GTAG"
          git push origin "$GTAG"

      - name: "Create GitHub Release"
        env:
          GH_TOKEN: ${{ github.token }}
          GTAG: ${{ needs.plan.outputs.gtag }}
        run: |
          test -n "$GTAG"  # fail if empty
          echo "Trying to create GitHub Release [$GTAG]"
          gh release create "$GTAG" --verify-tag --title "$GTAG" --generate-notes

  deploy-dev:
    name: "Deploy to dev"
    needs: [ plan, gtag-release ]
    permissions: { contents: read, id-token: write }
    concurrency:
      group: "pipeline-pdp-main-deploy-dev"
      cancel-in-progress: true
    uses: ./.github/workflows/rw-pdp-deploy-main.yml
    with:
      target: "dev"
      rtag: ${{ needs.plan.outputs.gtag }}
    secrets: inherit

  deploy-uat:
    name: "Deploy to uat"
    needs: [ plan, deploy-dev ]
    permissions: { contents: read, id-token: write }
    concurrency:
      group: "pipeline-pdp-main-deploy-uat"
      cancel-in-progress: true
    uses: ./.github/workflows/rw-pdp-deploy-main.yml
    with:
      target: "uat"
      rtag:    ${{ needs.plan.outputs.gtag }}
    secrets: inherit

  e2etest-uat:
    name: "E2E test uat"
    needs: [ deploy-uat ]
    permissions: { contents: read, packages: read }
    uses: ./.github/workflows/rw-pdp-e2etest.yml
    with:
      target: "uat"
    secrets: inherit

  deploy-staging:
    name: "Deploy to staging"
    needs: [ plan, e2etest-uat ]
    permissions: { contents: read, id-token: write }
    concurrency:
      group: "pipeline-pdp-main-deploy-staging"
      cancel-in-progress: true
    uses: ./.github/workflows/rw-pdp-deploy-main.yml
    with:
      target: "staging"
      rtag:   ${{ needs.plan.outputs.gtag }}
    secrets: inherit

  e2etest-staging:
    name: "E2E test staging"
    needs: [ deploy-staging ]
    permissions: { contents: read, packages: read }
    uses: ./.github/workflows/rw-pdp-e2etest.yml
    with:
      target: "staging"
    secrets: inherit
