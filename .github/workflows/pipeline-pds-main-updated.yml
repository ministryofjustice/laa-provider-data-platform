name: "Pipeline: PDS main updated"

on:
  push:
    branches: [ main ]
    paths:    [ "provider-data-api/**", "provider-data-e2e/**", "provider-data-service/**",
                "helm_deploy/provider-data-service/**" ]
  workflow_dispatch:
    inputs:
      reltype: { type: choice, required: true, options: [ "auto", "none", "patch", "minor", "major" ],
                 description: "Release type" }

jobs:
  plan:
    name: "Plan"
    permissions: { contents: read }
    runs-on: ubuntu-latest
    outputs:
      reltype: ${{ steps.vars.outputs.reltype }}  # type of release (or none)
      itag:    ${{ steps.vars.outputs.itag }}     # name of the tag to create
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0    # } ensure that previous tags are included
          fetch-tags: true  # }

      - name: "Determine variable values"
        id:   vars
        shell: bash
        run: |
          set -eu
          PREVTAG="$(git describe --tags --abbrev=0 --match "pds-v[0-9]*" 2>/dev/null || echo pds-v0.0.0)"
          if git rev-parse -q --verify "$PREVTAG" >/dev/null 2>&1; then COMMITS="${PREVTAG}..HEAD"; else COMMITS="HEAD"; fi
          BUMP="none"
          if ${{ github.event_name == 'workflow_dispatch' && inputs.reltype != 'auto' }}; then BUMP="${{ inputs.reltype }}"
          elif (git log --no-merges --format=%s "$COMMITS" | grep -Eqm1 '^[a-z]+(\([^)]+\))?!: '); then BUMP="major"
          elif (git log --no-merges --format=%B "$COMMITS" | grep -Eqm1 'BREAKING[ -]CHANGE:'); then BUMP="major"
          elif (git log --no-merges --format=%s "$COMMITS" | grep -Eqm1 '^feat(\([^)]+\))?: '); then BUMP="minor"
          elif (git log --no-merges --format=%s "$COMMITS" | grep -Eqm1 '^(fix|chore|refactor)(\([^)]+\))?: '); then BUMP="patch"
          fi
          if [[ "$PREVTAG" =~ ^pds-v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            MAJOR=${BASH_REMATCH[1]}; MINOR=${BASH_REMATCH[2]}; PATCH=${BASH_REMATCH[3]}
          else
            echo "Unrecognised last tag \"$PREVTAG\", using pds-v0.0.0" >&2
            MAJOR=0; MINOR=0; PATCH=0
          fi
          case "$BUMP" in
            major) MAJOR=$((MAJOR+1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR+1)); PATCH=0 ;;
            patch) PATCH=$((PATCH+1)) ;;
            none)  ;;
          esac
          NEXTTAG=""; if [[ "$BUMP" != "none" ]]; then NEXTTAG="pds-v${MAJOR}.${MINOR}.${PATCH}"; fi
          echo "- PREVTAG=$PREVTAG; MAJOR=$MAJOR; MINOR=$MINOR; PATCH=$PATCH"
          echo "- github.event_name=${{ github.event_name }}"
          echo "- github.ref_name=${{ github.ref_name }}"
          echo "- outputs.itag=$NEXTTAG"
          echo "- outputs.reltype=$BUMP"
          echo "itag=$NEXTTAG" >> "$GITHUB_OUTPUT"
          echo "reltype=$BUMP" >> "$GITHUB_OUTPUT"

  source-scan:
    name: "Source scan"
    needs: [ plan ]
    permissions: { contents: read }
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - run: |
          ### Check the Helm chart lints OK
          helm lint ./helm_deploy/provider-data-service --quiet --strict

  make-image:
    name: "Build ${{ needs.plan.outputs.itag }}"
    if:   needs.plan.outputs.itag && (needs.plan.outputs.reltype != 'none')
    needs: [ plan ]
    permissions: { contents: read, id-token: write, packages: write }
    uses: ./.github/workflows/rw-pds-build.yml
    with:
      itag: ${{ needs.plan.outputs.itag }}
    secrets: inherit

  tag-release:
    name: "Git tag and GitHub Release"
    needs: [ plan, make-image ]
    permissions: { contents: write }
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: "Create Git tag"
        env:
          TAG: ${{ needs.plan.outputs.itag }}
        run: |
          test -n "$TAG"  # fail if empty
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # Try creating the tag (skip if it already exists remotely)
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG$"; then
            echo "Tag $TAG already exists on remote. Skipping tag creation."
            exit 0
          fi
          git tag -a "$TAG" -m "Release $TAG"
          # Push, but do not fail if rejected
          git push origin "$TAG" || echo "Tag push skipped (tag already exists)."

      - name: "Create GitHub Release (safe, skip if exists)"
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ needs.plan.outputs.itag }}
        run: |
          if [[ "$TAG" == "pds-v0.0.0" ]]; then exit 0; fi
          echo "Checking if GitHub Release $TAG already existsâ€¦"
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG already exists. Skipping release creation."
            exit 0
          fi
          gh release create "$TAG" --verify-tag --title "$TAG" --generate-notes

  deploy-dev:
    name: "Deploy to dev"
    needs: [ plan, tag-release ]
    permissions: { contents: read, id-token: write }
    concurrency:
      group: "pipeline-pds-main-deploy-dev"
      cancel-in-progress: true
    uses: ./.github/workflows/rw-pds-deploy-main.yml
    with:
      target: "dev"
      tag: ${{ needs.plan.outputs.itag }}
    secrets: inherit

  deploy-uat:
    name: "Deploy to uat"
    needs: [ plan, deploy-dev ]
    permissions: { contents: read, id-token: write }
    concurrency:
      group: "pipeline-pds-main-deploy-uat"
      cancel-in-progress: true
    uses: ./.github/workflows/rw-pds-deploy-main.yml
    with:
      target: "uat"
      tag:    ${{ needs.plan.outputs.itag }}
    secrets: inherit

  e2etest-uat:
    name: "E2E test uat"
    needs: [ deploy-uat ]
    permissions: { contents: read, packages: read }
    uses: ./.github/workflows/rw-pds-e2etest.yml
    with:
      target: "uat"
    secrets: inherit

  deploy-staging:
    name: "Deploy to staging"
    needs: [ plan, e2etest-uat ]
    permissions: { contents: read, id-token: write }
    concurrency:
      group: "pipeline-pds-main-deploy-staging"
      cancel-in-progress: true
    uses: ./.github/workflows/rw-pds-deploy-main.yml
    with:
      target: "staging"
      tag:    ${{ needs.plan.outputs.itag }}
    secrets: inherit

  e2etest-staging:
    name: "E2E test staging"
    needs: [ deploy-staging ]
    permissions: { contents: read, packages: read }
    uses: ./.github/workflows/rw-pds-e2etest.yml
    with:
      target: "staging"
    secrets: inherit
