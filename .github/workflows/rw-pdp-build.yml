name: "Reusable workflow: PDP build, push & publish"

on:
  workflow_call:
    inputs:
      itag: { type: string, required: true }
      mtag: { type: string, required: false }
  workflow_dispatch:
    inputs:
      itag: { type: string, required: true, description: "Immutable registry tag (e.g. 'v1.4.2', 'pr-925-0af')" }
      mtag: { type: string, required: false, description: "Optional mutable registry tag (e.g. 'pr-925')" }

jobs:
  build:
    name: "Build OCI image"
    permissions: { contents: read, id-token: write, packages: write }
    runs-on: ubuntu-latest
    steps:
      - name: "Validate registry tag names"
        shell: bash
        run: |
          set -eu
          check_rtag() {
            # `vM.N.P[-suffix]` or `pr-N[-suffix]`
            printf '%s\n' "$2" | grep -Eq '^(v[0-9]+\.[0-9]+\.[0-9]+|pr-[0-9]+)(-[0-9A-Za-z_-]+)?$' || {
              printf 'Error: disallowed characters in %s: [%s]\n' "$1" "$2" >&2
              return 1
            }
          }
          check_rtag itag "${{ inputs.itag }}"
          check_rtag mtag "${{ inputs.mtag || 'pr-1' }}"

      - uses: actions/checkout@v6

      - name: "Set up Java 25 (Temurin distro)"
        uses: actions/setup-java@v5
        with:
          distribution: "temurin"
          java-version: "25"

      - name: "Set up Gradle"
        uses: gradle/actions/setup-gradle@v5

      - name: "Build and test app"
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
          ITAG:         ${{ inputs.itag }}
        run: |
          set -eu
          # Substitute in gradle.properties `version=<itag>`
          sed -E -i.bak -e "s|^(version[[:space:]]*=[[:space:]]*).*|\1${ITAG#v}|" gradle.properties \
              && rm -f gradle.properties.bak
          ./gradlew clean build integrationTest

      - name: "Publish OpenAPI specification models package (main branch)"
        if:   github.ref == 'refs/heads/main'
        shell: bash
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          ./gradlew :provider-data-api:publish --info

      - name: "Upload Checkstyle report for app"
        if:   always()
        uses: actions/upload-artifact@v6
        with:
          name: checkstyle-report
          path: provider-data-service/build/reports/checkstyle
          retention-days: 7

      - name: "Upload test report for app"
        if:   always()
        uses: actions/upload-artifact@v6
        with:
          name: test-report
          path: provider-data-service/build/reports/tests
          retention-days: 7

      - name: "Upload integration test report for app"
        if:   always()
        uses: actions/upload-artifact@v6
        with:
          name: integration-test-report
          path: provider-data-service/build/reports/integrationTest
          retention-days: 7

      - name: "Upload JaCoCo coverage report"
        if:   always()
        uses: actions/upload-artifact@v6
        with:
          name: jacoco-coverage-report
          path: provider-data-service/build/reports/jacoco
          retention-days: 7

      - name: "Authenticate with Amazon ECR"
        id:   ecr_auth
        uses: ./.github/actions/cp-ecr-auth
        with:
          ecr_region:         ${{ vars.DPD_ECR_REGION }}
          ecr_role_to_assume: ${{ secrets.DPD_ECR_ROLE_TO_ASSUME }}

      - name: "Build and push image"
        if:   steps.ecr_auth.outputs.ecr_auth_attempted == 'true'
        uses: ./.github/actions/build-push-image
        with:
          image: ${{ steps.ecr_auth.outputs.ecr_registry }}/${{ vars.DPD_ECR_REPOSITORY }}
          itag:  ${{ inputs.itag }}
          mtag:  ${{ inputs.mtag }}
          module_dir: "provider-data-service" # Point to the new service module

      - name: "Send failure Slack message"
        if:   failure()
        shell: bash
        env:
          RTAG: ${{ inputs.mtag || inputs.itag }}
        run: |
          set -eu
          RUN_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          case "$RTAG" in
            pr-*) exit ;; # PR builds do NOT send alerts
            v*)   MESSAGE=" :github-failure:  Failed to build main @${RTAG}. View run log at ${RUN_URL}" ;;
            *)    MESSAGE=" :github-failure:  Failed to build tag [${RTAG}]. View run log at ${RUN_URL}" ;;
          esac
          curl -X POST -H "Content-Type: application/json" --data "{\"text\": \"${MESSAGE}\"}" \
              "${{ secrets.SLACK_WEBHOOK }}"
