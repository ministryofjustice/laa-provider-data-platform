name: "Reusable workflow: PDA (unified) end-to-end test"

on:
  workflow_call:
    inputs:
      application: { type: string, required: true }
      target:      { type: string, required: true }
      rel:         { type: string, required: false, default: "" }
      servicePort: { type: string, required: false, default: "8080" }
  workflow_dispatch:
    inputs:
      application: { type: choice, required: true, options: [ "provider-data-service" ],
                     description: "Application to test" }
      target:      { type: choice, required: true, options: [ "uat", "staging", "prod" ], default: "uat",
                     description: "Target environment" }
      rel:         { type: string, required: false, default: "",
                     description: "Optional release name (e.g. 'pr-913', defaults to stable release)" }
      servicePort: { type: number, required: false, default: 8080,
                     description: "Optional service port to forward (e.g. '8080', defaults to 8080)" }

jobs:
  e2etest:
    name: "E2E test ${{ inputs.application }} in ${{ inputs.target }} of ${{ inputs.rel || 'stable' }}"
    permissions: { contents: read, packages: read }
    runs-on: ubuntu-latest
    environment: ${{ inputs.target }}
    concurrency: rw-pdu-e2e-${{ inputs.target }}-${{ inputs.rel || 'stable' }}
    steps:
      - uses: actions/checkout@v6

      - name: "Determine variable values"
        id:   vars
        shell: bash
        env:
          APP:    ${{ inputs.application }}
          REL:    ${{ inputs.rel || 'stable' }}
          SP:     ${{ inputs.servicePort }}
          TARGET: ${{ inputs.target }}
        run: |
          echo "Run e2e tests - app: [$APP], target: [$TARGET], rel: [$REL], servicePort: [$SP]"
          # Map target to profile
          case "$TARGET" in
            dev)     PROFILE=dev ;;
            uat)     PROFILE=uat ;;
            staging) PROFILE=staging ;;
            prod)    PROFILE=prod ;;
            *)       exit 1 ;;
          esac
          # Determine service name and E2E project based on application
          case "$APP" in
            provider-data-service)
              E2E_PROJECT="provider-data-e2e"
              SVC="pdp-${REL}-provider-data-service"
              ;;
            *)
              echo "Unknown application: $APP" >&2
              exit 1
              ;;
          esac
          echo "Resolved E2E project:  [$E2E_PROJECT]"
          echo "Resolved profile name: [$PROFILE]"
          echo "Resolved service name: [$SVC]"
          echo "e2e_project=$E2E_PROJECT" >> "$GITHUB_OUTPUT"
          echo "profile=$PROFILE" >> "$GITHUB_OUTPUT"
          echo "svc=$SVC" >> "$GITHUB_OUTPUT"

      - name: "Set up Java 25 (Temurin distro)"
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "25"

      - name: "Set up Gradle (cache)"
        uses: gradle/actions/setup-gradle@v5

      - name: "Authenticate with Kubernetes cluster"
        id:   kube_auth
        uses: ./.github/actions/cp-kube-auth
        with:
          kube_cert:      ${{ secrets.DPD_KUBE_CERT }}
          kube_cluster:   ${{ secrets.DPD_KUBE_CLUSTER }}
          kube_namespace: ${{ secrets.DPD_KUBE_NAMESPACE }}
          kube_token:     ${{ secrets.DPD_KUBE_TOKEN }}

      - name: "Display Kubernetes context (diagnostic-only)"
        if:   steps.kube_auth.outputs.kube_auth_attempted == 'true'
        run: |
          kubectl config current-context
          kubectl -n "${{ secrets.DPD_KUBE_NAMESPACE }}" get svc "${{ steps.vars.outputs.svc }}" -o wide || true

      - name: "Wait for rollout" # Because this tends to be run just after a deployment
        if:   steps.kube_auth.outputs.kube_auth_attempted == 'true'
        run: |
          kubectl -n "${{ secrets.DPD_KUBE_NAMESPACE }}" rollout status deploy/"${{ steps.vars.outputs.svc }}" --timeout=180s || true

      - name: "Port-forward service -> localhost:18080"
        if:   steps.kube_auth.outputs.kube_auth_attempted == 'true'
        env:
          NS:  ${{ secrets.DPD_KUBE_NAMESPACE }}
          SP:  ${{ inputs.servicePort }}
          SVC: ${{ steps.vars.outputs.svc }}
        run: |
          echo "Port-forwarding svc/${SVC} on ${SP} â†’ localhost:18080 in namespace=${NS}"
          kubectl -n "${NS}" port-forward "svc/${SVC}" 18080:"${SP}" &
          echo $! > /tmp/pf.pid
          sleep 3

      - name: "Run E2E tests"
        if:   steps.kube_auth.outputs.kube_auth_attempted == 'true'
        env:
          AUTH_TOKEN:   ""
          E2E_PROJECT:  ${{ steps.vars.outputs.e2e_project }}
          GITHUB_TOKEN: ${{ github.token }}
          GITHUB_ACTOR: ${{ github.actor }}
          PROFILE:      ${{ steps.vars.outputs.profile }}
        run: |
          ./gradlew ":${E2E_PROJECT}:e2eTest" \
            -Penv="$PROFILE" \
            -Dbase.url="http://127.0.0.1:18080" \
            -Dauth.token="${AUTH_TOKEN}" \
            --stacktrace

      - name: "Upload E2E reports"
        if:   always()
        uses: actions/upload-artifact@v6
        with:
          name: e2e-${{ inputs.target }}-${{ inputs.rel || 'stable' }}-reports
          path: |
            ${{ steps.vars.outputs.e2e_project }}/build/reports/**
            ${{ steps.vars.outputs.e2e_project }}/build/test-results/**
          if-no-files-found: ignore

      - name: "Cleanup port-forward"
        if:   always()
        run: |
          test -f /tmp/pf.pid && kill "$(cat /tmp/pf.pid)" 2>/dev/null || true
          echo "==== Port-forward processes ===="
          ps -ef | grep "[p]ort-forward" || true
