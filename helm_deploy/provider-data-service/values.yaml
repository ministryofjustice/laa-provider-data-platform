# values.yaml
# Default configuration values for the chart.

# The target environment value will be overridden in the environment values file (for all deployments):
target:
  environment: "placeholder"

# The replica count value will be overridden in the environment values file (for preview, staging, production):
replicaCount: 3

image:
  pullPolicy: IfNotPresent
  # The Docker registry image name and tag values will be overridden by command-line arguments (for all deployments):
  repository: "registry/repository"
  tag: "latest"

podSecurityContext:
  runAsNonRoot: true
  seccompProfile:
    type: RuntimeDefault
securityContext:
  allowPrivilegeEscalation: false
  #readOnlyRootFilesystem: true  # Caused Tomcat exception writing to /tmp.
  capabilities:
    drop: ["ALL"]

resources:
  requests:
    memory: "512Mi"
    cpu: "500m"
  limits:
    memory: "1Gi"
    cpu: "1000m"

# Hostname suffix for dedicated ingress (e.g., "-1", "-2", "-pr-123")
# Will be overridden by command-line argument for each deployment:
hostnameSuffix: ""

# Configuration for canary deployments using the shared ingress
canary:
  # Role of this release in canary deployment:
  # - none: No shared ingress (dedicated ingress only)
  # - stable: Base ingress for canary split (receives 100% - canary weight)
  # - canary: Canary ingress for traffic testing (receives canary weight %)
  role: "none"
  # Percentage of traffic to route to canary release (0-100)
  # Only used when role=canary. Adjust via kubectl patch, not redeployment.
  weight: 0

# Old Dockerfile had `ENV JAVA_TOOL_OPTION="-XX:InitialRAMPercentage=50.0 -XX:MaxRAMPercentage=80.0"`.
# `-XX:MaxDirectMemorySize` is needed for Lettuce (Redis client) because the Paketo buildpack defaults to just `10M`.
# Mem calc => `-Xmx158M -Xss1M -XX:MaxDirectMemorySize=10M -XX:MaxMetaspaceSize=120M -XX:ReservedCodeCacheSize=240M`.
javaToolOptions: >-
  -Xms512M -Xmx512M -Xss256K
  -XX:MaxDirectMemorySize=180M
  -XX:MaxMetaspaceSize=120M
  -XX:ReservedCodeCacheSize=120M

secretNames:
  envConfig: app-secrets
  rdspgConnection: rds-postgresql-instance-output
  redisConnection: app-redis

prometheus:
  metricsEnabled: true
  # The metrics qualifier value will be overridden in the environment values file (for all deployments):
  metricsQualifier: "placeholder"

# Configuration for the Kubernetes Service that exposes the application.
service:
  type: ClusterIP
  port: 8080

# Configuration for rate limiting.
rateLimit:
  rps: ""    # requests per second, override in values-*.yaml as needed
  rpm: ""    # requests per minute, override in values-*.yaml as needed
  burst: ""  # burst size, override in values-*.yaml as needed

# Configuration for Ingress to expose the service within the cluster.
# The internal ingress is currently only used by release apps.
ingressInternal:
  enabled: false  # The enabled value will be overridden in the environment values file.
  annotations:
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
  className: "internal-non-prod"
  hosts:
    # The host value will be overridden in the environment values file (for release deployments),
    # or by a command-line argument (for preview deployments):
    - host: "laa-provider-data-platform.internal-non-prod.cloud-platform.service.justice.gov.uk"

# Configuration for Ingress to expose the service outside the cluster.
ingress:
  enabled: false  # The enabled value will be overridden in the environment values file.
  annotations:
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/enable-modsecurity: "true"
    nginx.ingress.kubernetes.io/modsecurity-snippet: |
      SecRuleEngine On
      SecDefaultAction "phase:2,pass,log,tag:github_team=laa-data-stewardship-cse-team"
  # The className value will be overridden in the environment values file (for production deployments):
  className: "modsec-non-prod"
  hosts:
    # The host value will be overridden in the environment values file (for release deployments),
    # or by a command-line argument (for preview deployments):
    - host: "laa-provider-data-platform.apps.cloud-platform.service.justice.gov.uk"
  # The hosts values will be overridden in the environment values file (for release deployments),
  # or by a command-line argument (for preview deployments) [tls only needed for this ingress]:
  tls:
    - hosts:
        - "laa-provider-data-platform.apps.cloud-platform.service.justice.gov.uk"

# Configuration for Ingress to expose the service outside the cluster (using shared hostname).
# The shared ingress is currently only used by release apps.
ingressShared:
  # enabled overridden in the environment values file.
  enabled: false
  annotations:
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/enable-modsecurity: "true"
    nginx.ingress.kubernetes.io/modsecurity-snippet: |
      SecRuleEngine On
      SecDefaultAction "phase:2,pass,log,tag:github_team=laa-data-stewardship-cse-team"
  # The className value will be overridden in the environment values file (for production deployments):
  className: "modsec"
  hosts:
    # The host value will be overridden in the environment values file (for release deployments),
    # or by a command-line argument (for preview deployments):
    - host: "laa-provider-data-platform.apps.live.cloud-platform.service.justice.gov.uk"
