spring:
  application:
    name: provider-data-platform
  datasource:
    hikari:
      maximum-pool-size: 10  # Maximum connections per pod
      minimum-idle: 3        # Start with 3, grow to max under load
      idle-timeout: 300000   # 5 minutes - close idle connections
      connection-timeout: 30000        # 30 seconds - fail fast if pool exhausted
      max-lifetime: 1800000            # 30 minutes - refresh connections periodically
      leak-detection-threshold: 60000  # 60 seconds - detect connection leaks
  profiles:
    active: ${TARGET_ENVIRONMENT:local}
  threads:
    virtual:
      enabled: true

  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true

info:
  app:
    name: provider-data-platform
    description: Implements a REST API for retrieving and updating provider firm, office, contract and schedule data.
    version: 1.0.0

logging:
  level:
    root: INFO
    ch: WARN
    io: WARN
    jakarta: WARN
    javax: WARN
    net: WARN
    org.hibernate: WARN
    org.springframework: WARN
    uk.gov.justice.laadata.providers: INFO
    uk.gov.laa.springboot.auth: WARN
  pattern:
    console: "%gray(%d{yyyy-MM-dd HH:mm:ss.SSS}) [%thread] [RequestId=%X{requestId}] [%highlight(%-5level)] [%cyan(%class{0}.%M:%L)] - %msg %n"

management:
  endpoints:
    web:
      exposure:
        include: [ health, info, prometheus ]
  metrics:
    enable:
      spring:
        security: false  # Disable meters with an ID starting with `spring.security`
    tags:
      application: provider-data-platform  # Used by Grafana dashboard

springdoc:
  default-flat-param-object: true
  swagger-ui:
    display-request-duration: true
    operations-sorter: alpha
    tags-sorter: alpha
    urls-primary-name: v1 - default
  writer-with-default-pretty-printer: true

---
spring:
  config:
    activate:
      on-profile: "!local"
  # Datasource credentials for all non-local profiles (no way to "unset" config for the local profile)
  datasource:
    url: ${SPRING_DATASOURCE_URL}
    username: ${SPRING_DATASOURCE_USERNAME}
    password: ${SPRING_DATASOURCE_PASSWORD}

# Use structured logging for non-local profiles (no way to "unset" config for the local profile)
logging:
  structured:
    ecs:
      service:
        environment: ${TARGET_ENVIRONMENT:unknown}
    format:
      console: ecs

# Sentry is only needed for non-local profiles.
sentry:
  dsn: ${SENTRY_DSN:}
  environment: ${TARGET_ENVIRONMENT:unknown}
  send-default-pii: false
  traces-sample-rate: ${SENTRY_TRACESSAMPLERATE:0.2}
